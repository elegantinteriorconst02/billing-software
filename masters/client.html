<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Client Master</title>

  <!-- MENU CSS -->
  <link rel="stylesheet" href="../assets/menu.css">

  <style>
    body{
      margin:0;
      font-family:sans-serif;
      background:#f4f7f6;
    }

    /* main content */
    .main{
      padding:20px;
      max-width:1100px;
    }

    h2{
      border-bottom:2px solid #4a90e2;
      padding-bottom:10px;
      margin-top:0;
    }

    .container{
      display:grid;
      grid-template-columns:350px 1fr;
      gap:30px;
    }

    .card{
      background:#fff;
      padding:20px;
      border-radius:8px;
      box-shadow:0 2px 5px rgba(0,0,0,0.1);
    }

    .form-group{ margin-bottom:12px; }
    label{ font-weight:bold; font-size:0.9em; }
    input, textarea{
      width:100%;
      padding:8px;
      border:1px solid #ccc;
      border-radius:4px;
    }
    textarea{ resize:vertical; height:60px; }

    .btn-group{
      display:flex;
      gap:10px;
      margin-top:15px;
    }

    button{
      cursor:pointer;
      padding:10px;
      border:none;
      border-radius:4px;
      font-weight:bold;
    }

    .btn-save{ background:#28a745; color:#fff; flex:2; }
    .btn-reset{ background:#6c757d; color:#fff; flex:1; }

    table{
      width:100%;
      border-collapse:collapse;
      background:#fff;
      border-radius:8px;
      overflow:hidden;
    }

    th, td{
      padding:12px;
      border-bottom:1px solid #eee;
    }

    th{
      background:#4a90e2;
      color:#fff;
      text-align:left;
    }

    tr:hover{ background:#f9f9f9; }

    .actions button{
      padding:4px 8px;
      font-size:12px;
      margin-right:5px;
    }

    .btn-edit{ background:#ffc107; }
    .btn-delete{ background:#dc3545; color:#fff; }

    #clientSearch{
      width:100%;
      padding:8px;
      margin:15px 0;
    }

    @media(max-width:900px){
      .container{
        grid-template-columns:1fr;
      }
    }
  </style>
</head>

<body>

<!-- MENU LOAD -->
<div id="menuContainer"></div>

<!-- PAGE CONTENT -->
<div class="main">

  <h2>Client Master</h2>

  <input
    type="text"
    id="clientSearch"
    placeholder="Search by name / phone / gst / email / pin"
  />

  <div class="container">

    <!-- FORM -->
    <div class="card">
      <form id="clientForm">
        <input type="hidden" id="clientId">

        <div class="form-group">
          <label>Client Name *</label>
          <input type="text" id="name" required>
        </div>

        <div class="form-group">
          <label>Mobile</label>
          <input type="text" id="mobile">
        </div>

        <div class="form-group">
          <label>Email</label>
          <input type="email" id="email">
        </div>

        <div class="form-group">
          <label>GSTIN</label>
          <input type="text" id="gst">
        </div>

        <div class="form-group">
          <label>State</label>
          <input type="text" id="state">
        </div>

        <div class="form-group">
          <label>PIN Code</label>
          <input type="text" id="pin">
        </div>

        <div class="form-group">
          <label>Address</label>
          <textarea id="address"></textarea>
        </div>

        <div class="form-group">
          <label>Notes</label>
          <textarea id="notes"></textarea>
        </div>

        <div class="btn-group">
          <button class="btn-save" id="saveBtn">Save Client</button>
          <button type="button" class="btn-reset" onclick="resetForm()">Reset</button>
        </div>
      </form>
    </div>

    <!-- TABLE -->
    <div class="card">
      <table>
        <thead>
          <tr>
            <th>Name</th>
            <th>Mobile</th>
            <th>GST</th>
            <th>State</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="clientTableBody"></tbody>
      </table>
    </div>

  </div>
</div>

<!-- DATA -->

<script type="module">

import {
  getClients,
  getClientById,
  saveClient,
  updateClient,
  deleteClient
} from "../data/client.js";

const form = document.getElementById("clientForm");
const tableBody = document.getElementById("clientTableBody");
const searchInput = document.getElementById("clientSearch");

const clientId = document.getElementById("clientId");
const name = document.getElementById("name");
const mobile = document.getElementById("mobile");
const email = document.getElementById("email");
const gst = document.getElementById("gst");
const state = document.getElementById("state");
const pin = document.getElementById("pin");
const address = document.getElementById("address");
const notes = document.getElementById("notes");
const saveBtn = document.getElementById("saveBtn");


window.addEventListener("DOMContentLoaded", async () => {
  await refreshList();
});

form.addEventListener("submit", async (e) => {
  e.preventDefault();

  const client = {
    id: clientId.value,
    name: name.value,
    mobile: mobile.value,
    email: email.value,
    gst: gst.value,
    state: state.value,
    pin: pin.value,
    address: address.value,
    notes: notes.value
  };

  if (client.id) {
    await updateClient(client);
  } else {
    await saveClient(client);
  }

  resetForm();
  await refreshList();
});

async function refreshList() {
  const q = (searchInput.value || "").toLowerCase();
  tableBody.innerHTML = "";

  const clients = await getClients();

  clients
    .filter(c =>
      c.name?.toLowerCase().includes(q) ||
      c.mobile?.includes(q) ||
      c.email?.toLowerCase().includes(q) ||
      c.gst?.toLowerCase().includes(q) ||
      c.pin?.includes(q)
    )
    .forEach(c => {
      tableBody.innerHTML += `
        <tr>
          <td><b>${c.name}</b></td>
          <td>${c.mobile || ""}</td>
          <td>${c.gst || "-"}</td>
          <td>${c.state || ""}</td>
          <td class="actions">
            <button onclick="editEntry('${c.id}')">Edit</button>
            <button onclick="deleteEntry('${c.id}')">Delete</button>
          </td>
        </tr>
      `;
    });
}

searchInput.addEventListener("input", refreshList);

window.editEntry = async function(id) {
  const c = await getClientById(id);
  if (!c) return;

  clientId.value = c.id;
  name.value = c.name;
  mobile.value = c.mobile;
  email.value = c.email;
  gst.value = c.gst;
  state.value = c.state;
  pin.value = c.pin;
  address.value = c.address;
  notes.value = c.notes;
  saveBtn.textContent = "Update Client";
};

window.deleteEntry = async function(id) {
  if (confirm("Delete this client?")) {
    await deleteClient(id);
    await refreshList();
  }
};

window.resetForm = function(){
  form.reset();
  clientId.value = "";
  saveBtn.textContent = "Save Client";
};

</script>


<!-- MENU -->
<script src="../shared/menu.js"></script>
<script>
fetch("../shared/menu.html")
  .then(r=>r.text())
  .then(html=>{
    document.getElementById("menuContainer").innerHTML = html;
    initMenu();
  });
</script>

</body>
</html>
