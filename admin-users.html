<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>User Management</title>
<link rel="stylesheet" href="assets/menu.css">
<style>
.main{padding:20px}
table{width:100%;border-collapse:collapse}
th,td{border:1px solid #ccc;padding:8px}
th{background:#eee}
button{padding:4px 8px}
</style>
</head>

<body>

<div id="menuContainer"></div>

<div class="main">
<h2>ğŸ‘¤ User Management</h2>

<table>
<thead>
<tr>
  <th>Name</th>
  <th>Email</th>
  <th>Role</th>
  <th>Status</th>
  <th>Action</th>
</tr>
</thead>
<tbody id="rows"></tbody>
</table>

<h3>ğŸ“œ Audit Log</h3>
<ul id="audit"></ul>
</div>

<script>
const admin = JSON.parse(localStorage.getItem("user")||"{}");

if(admin.role !== "admin"){
  alert("Admin only");
  location.href="dashboard.html";
}

let users = JSON.parse(localStorage.getItem("users")||"[]");
let audit = JSON.parse(localStorage.getItem("auditLog")||"[]");

function log(action, target){
  audit.unshift({
    time: new Date().toLocaleString(),
    by: admin.name,
    action,
    target
  });
  localStorage.setItem("auditLog", JSON.stringify(audit));
}

/* render */
function render(){
  rows.innerHTML="";
  users.forEach(u=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${u.name}</td>
      <td>${u.email}</td>
      <td>
        <select onchange="setRole('${u.uid}',this.value)">
          <option value="staff" ${u.role==="staff"?"selected":""}>staff</option>
          <option value="admin" ${u.role==="admin"?"selected":""}>admin</option>
        </select>
      </td>
      <td>${u.approved?"âœ… Approved":"â³ Pending"}</td>
      <td>
        ${u.approved?"":"<button onclick=\"approve('"+u.uid+"')\">Approve</button>"}
      </td>
    `;
    rows.appendChild(tr);
  });

  auditEl.innerHTML="";
  audit.forEach(a=>{
    const li=document.createElement("li");
    li.textContent =
      `${a.time} â€“ ${a.by} ${a.action} ${a.target}`;
    auditEl.appendChild(li);
  });
}

/* approve */
function approve(uid){
  const u=users.find(x=>x.uid===uid);
  if(!u) return;

  u.approved=true;
  log("approved", u.email);

  localStorage.setItem("users",JSON.stringify(users));
  render();
}

/* role change */
function setRole(uid,role){
  const u=users.find(x=>x.uid===uid);
  if(!u) return;

  u.role=role;
  log("changed role to "+role, u.email);

  localStorage.setItem("users",JSON.stringify(users));
}

render();
</script>

<script src="shared/menu.js"></script>
<script>
fetch("shared/menu.html")
  .then(r=>r.text())
  .then(h=>{
    menuContainer.innerHTML=h;
    initMenu();
  });
</script>

</body>
</html>
